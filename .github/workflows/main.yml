name: Deploy to Server

on:
  push:
    branches:
      - main   # ganti sesuai branch production kamu

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, bcmath, curl, dom, gd, xml

      # Install Dependencies via Composer
      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # Install JS deps & build
      - name: Install npm dependencies & Build
        run: |
          npm ci
          npm run build

      # Deploy to Server via rsync
      - name: Deploy to Server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avz --delete
          path: ./        # folder source (semua hasil build + vendor)
          remote_path: /home/$SSH_USER/voxy-club-indonesia   # ganti sesuai folder server
          remote_host: ${{ secrets.SSH_HOST }}          # contoh: domainkamu.com atau IP server
          remote_user: ${{ secrets.SSH_USER }}          # contoh: username cPanel / SSH
          remote_port: ${{ secrets.SSH_PORT }}          # contoh: 65002 (isi sesuai Rumahweb kasih)
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}  # hasil export private key dari PuTTY ke OpenSSH
